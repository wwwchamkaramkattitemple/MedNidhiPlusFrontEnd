<div class="invoice-detail-container">
  <div class="invoice-detail-header">
    <div class="header-left">
      <button mat-button color="primary" routerLink="/billing">
        <mat-icon>arrow_back</mat-icon> Back to Invoices
      </button>
      <h1 class="mat-headline-4">Invoice #{{ invoice?.invoiceNumber }}</h1>
    </div>
    <div class="header-actions">
      <button mat-stroked-button (click)="printInvoice()">
        <mat-icon>print</mat-icon> Print
      </button>
      <button mat-stroked-button (click)="sendInvoice()">
        <mat-icon>email</mat-icon> Send
      </button>
      <button mat-stroked-button color="primary" (click)="editInvoice()">
        <mat-icon>edit</mat-icon> Edit
      </button>
      <button mat-stroked-button color="warn" (click)="deleteInvoice()">
        <mat-icon>delete</mat-icon> Delete
      </button>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-spinner">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="!isLoading && invoice" class="invoice-content">
    <div class="invoice-status-banner" [ngStyle]="{'background-color': getStatusColor(invoice.status)}">
      <span>{{ invoice.status }}</span>
      <button *ngIf="invoice.status !== 'Paid' && invoice.status !== 'Cancelled'" 
              mat-raised-button 
              color="primary" 
              (click)="recordPayment()">
        <mat-icon>payments</mat-icon> Record Payment
      </button>
    </div>

    <div class="invoice-info-section">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Invoice Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-grid">
            <div class="info-row">
              <div class="info-label">Invoice Number:</div>
              <div class="info-value">{{ invoice.invoiceNumber }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Invoice Date:</div>
              <div class="info-value">{{ formatDate(invoice.invoiceDate) }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Due Date:</div>
              <div class="info-value">{{ formatDate(invoice.dueDate) }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Status:</div>
              <div class="info-value">
                <span class="status-badge" [ngStyle]="{'background-color': getStatusColor(invoice.status)}">
                  {{ invoice.status }}
                </span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header>
          <mat-card-title>Patient Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-grid">
            <div class="info-row">
              <div class="info-label">Name:</div>
              <div class="info-value">{{ invoice.patient.firstName }} {{ invoice.patient.lastName }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Email:</div>
              <div class="info-value">{{ invoice.patient.email }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Phone:</div>
              <div class="info-value">{{ invoice.patient.phone }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Address:</div>
              <div class="info-value">{{ invoice.patient.address }}</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <mat-card class="items-card">
      <mat-card-header>
        <mat-card-title>Invoice Items</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="invoice.items" class="items-table">
          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>Description</th>
            <td mat-cell *matCellDef="let item">{{ item.description }}</td>
            <td mat-footer-cell *matFooterCellDef><strong>Totals</strong></td>
          </ng-container>

          <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef>Quantity</th>
            <td mat-cell *matCellDef="let item">{{ item.quantity }}</td>
            <td mat-footer-cell *matFooterCellDef></td>
          </ng-container>

          <ng-container matColumnDef="unitPrice">
            <th mat-header-cell *matHeaderCellDef>Unit Price</th>
            <td mat-cell *matCellDef="let item">&nbsp;&#8377;&nbsp;{{ item.unitPrice.toFixed(2) }}</td>
            <td mat-footer-cell *matFooterCellDef></td>
          </ng-container>

          <ng-container matColumnDef="discount">
            <th mat-header-cell *matHeaderCellDef>Discount</th>
            <td mat-cell *matCellDef="let item">&nbsp;&#8377;&nbsp;{{ item.discount.toFixed(2) }}</td>
            <td mat-footer-cell *matFooterCellDef></td>
          </ng-container>

          <ng-container matColumnDef="taxRate">
            <th mat-header-cell *matHeaderCellDef>Tax Rate</th>
            <td mat-cell *matCellDef="let item">{{ item.taxRate }}%</td>
            <td mat-footer-cell *matFooterCellDef></td>
          </ng-container>

          <ng-container matColumnDef="taxAmount">
            <th mat-header-cell *matHeaderCellDef>Tax Amount</th>
            <td mat-cell *matCellDef="let item">&nbsp;&#8377;&nbsp;{{ item.taxAmount.toFixed(2) }}</td>
            <td mat-footer-cell *matFooterCellDef><strong>&nbsp;&#8377;&nbsp;{{ invoice.taxAmount.toFixed(2) }}</strong></td>
          </ng-container>

          <ng-container matColumnDef="totalAmount">
            <th mat-header-cell *matHeaderCellDef>Total</th>
            <td mat-cell *matCellDef="let item">&nbsp;&#8377;&nbsp;{{ item.totalAmount.toFixed(2) }}</td>
            <td mat-footer-cell *matFooterCellDef><strong>&nbsp;&#8377;&nbsp;{{ invoice.totalAmount.toFixed(2) }}</strong></td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          <tr mat-footer-row *matFooterRowDef="displayedColumns"></tr>
        </table>
      </mat-card-content>
    </mat-card>

    <div class="invoice-summary-section">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Payment Summary</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="summary-grid">
            <div class="summary-row">
              <div class="summary-label">Subtotal:</div>
              <div class="summary-value">&nbsp;&#8377;&nbsp;{{ invoice.subTotal.toFixed(2) }}</div>
            </div>
            <div class="summary-row">
              <div class="summary-label">Tax Amount:</div>
              <div class="summary-value">&nbsp;&#8377;&nbsp;{{ invoice.taxAmount.toFixed(2) }}</div>
            </div>
            <div class="summary-row total-row">
              <div class="summary-label">Total Amount:</div>
              <div class="summary-value">&nbsp;&#8377;&nbsp;{{ invoice.totalAmount.toFixed(2) }}</div>
            </div>
            <div class="summary-row" *ngIf="invoice.paidAmount > 0">
              <div class="summary-label">Paid Amount:</div>
              <div class="summary-value">&nbsp;&#8377;&nbsp;{{ invoice.paidAmount.toFixed(2) }}</div>
            </div>
            <div class="summary-row" *ngIf="invoice.paidAmount > 0">
              <div class="summary-label">Payment Date:</div>
              <div class="summary-value">{{ formatDate(invoice.paymentDate) }}</div>
            </div>
            <div class="summary-row" *ngIf="invoice.paidAmount > 0">
              <div class="summary-label">Payment Method:</div>
              <div class="summary-value">{{ invoice.paymentMethod || 'N/A' }}</div>
            </div>
            <div class="summary-row balance-row" *ngIf="invoice.status !== 'Paid'">
              <div class="summary-label">Balance Due:</div>
              <div class="summary-value">&nbsp;&#8377;&nbsp;{{ calculateBalance().toFixed(2) }}</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card *ngIf="invoice.notes">
        <mat-card-header>
          <mat-card-title>Notes</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <p>{{ invoice.notes }}</p>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="invoice-footer">
      <div class="footer-info">
        <div>Created: {{ formatDate(invoice.createdAt) }}</div>
        <div>Last Updated: {{ formatDate(invoice.updatedAt) }}</div>
      </div>
    </div>
  </div>
</div>